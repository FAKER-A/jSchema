"use strict";var _typeof=typeof Symbol==="function"&&typeof Symbol.iterator==="symbol"?function(obj){return typeof obj}:function(obj){return obj&&typeof Symbol==="function"&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj};define(function(require){function jSchema(){var VERSION="0.4.0";var data=[],counter=0,_schema={tables:{},length:0};_schema.add=function(d,metadata){var _this=this;if((typeof d==="undefined"?"undefined":_typeof(d))!="object"){_log(1,d+" is not an object");return 0}var name=metadata&&metadata.name?metadata.name.toUpperCase():"TABLE"+counter++;if(_checkUnique(name,this.tables)===false)return 0;d=_colToUppercase(d);this.tables[name]={};this.tables[name].id=data.length;this.tables[name].pk=metadata&&metadata.primaryKey?metadata.primaryKey.toUpperCase():null;this.tables[name].rows=d.length;this.tables[name].col=Object.keys(d[0]);this.tables[name].col.forEach(function(c,i){_this.tables[name].col[i]=c});data.push(d);this.length=data.length;return this};_schema.get=function(d){d=d.toUpperCase();if(_checkForTable(d,this.tables)===false)return;return data[this.tables[d].id]};_schema.join=function(d1,d2){var _this2=this;d1=d1.toUpperCase();d2=d2.toUpperCase();var target=[];if(_checkForTable(d1,this.tables)===false)return;if(_checkForTable(d2,this.tables)===false)return;data[this.tables[d1].id].forEach(function(left){data[_this2.tables[d2].id].forEach(function(right){if(left[_this2.tables[d1].pk]==right[_this2.tables[d1].pk]){var dest={};for(var attrname in left){dest[d1+"."+attrname]=left[attrname]}for(attrname in right){dest[d2+"."+attrname]=right[attrname]}target.push(dest)}})});this.add(target,{name:"WORK."+d1+"_"+d2});return this};_schema.drop=function(d){d=d.toUpperCase();if(_checkForTable(d,this.tables)===false)return;data.splice(this.tables[d].id,1);for(var key in this.tables){if(this.tables[key].id>this.tables[d].id){this.tables[key].id-=1}}delete this.tables[d];this.length=data.length;return this};_schema.orderBy=function(d,attr){attr=attr||{};if(attr.clause===undefined)return 0;else attr.clause=attr.clause.toUpperCase();d=d.toUpperCase();if(_checkForTable(d,this.tables)===false)return;attr.order=attr.order!==undefined&&attr.order.toUpperCase()=="ASC"?"ASC":"DESC";var orderByData=data[this.tables[d].id].sort(function(d1,d2){return attr.order=="ASC"?d1[attr.clause]-d2[attr.clause]:d2[attr.clause]-d1[attr.clause]});this.add(orderByData,{name:attr.name||"WORK."+d+"_"+attr.clause+"_"+attr.order,primaryKey:attr.clause});return this};_schema.groupBy=function(d,attr){attr=attr||{};if(attr.dim===undefined||attr.metric===undefined){_log(1,"Must include a dimension and metrics to group by");return 0}else{attr.dim=attr.dim.toUpperCase();attr.metric=attr.metric.toUpperCase()}var dataset=data[this.tables[d].id],uniqueDimensions=_distinct(dataset,attr.dim),groupByData=[];uniqueDimensions.forEach(function(ud){var filterDataset=dataset.filter(function(d){return d[attr.dim]==ud});var reducedDataset=filterDataset.reduce(function(a,b){return{dim:ud,val:a.val+b[attr.metric]}},{dim:ud,val:0});groupByData.push(reducedDataset)});this.add(groupByData,{name:attr.name||"WORK."+d+"_"+attr.dim+"_"+attr.metric,primaryKey:attr.name});return this};_schema.filter=function(d,clauses){d=d.toUpperCase();if(arguments.length<3||arguments.length%2===0){_log(1,"Please include table, predicate, and expression");return 0}var subsetData=data[this.tables[d].id];for(var i=1;i<arguments.length;i+=2){var predicate=arguments[i].toUpperCase(),expression=arguments[i+1];subsetData=_filterPredicate(subsetData,predicate,expression)}this.add(subsetData,{name:"WORK."+d+"_"+arguments[1]+"_"+arguments[2]});return this};_schema.update=function(d,data){d=d.toUpperCase();if(_checkForTable(d,this.tables)===false)return;var pk=this.tables[d].pk;this.drop(d);this.add(data,{name:d,primaryKey:pk});return this};_schema.cleanUp=function(){for(var key in this.tables){if(key.indexOf("WORK.")>-1){this.drop(key)}}return this};console.log("jschema.js version "+VERSION+" loaded.");return _schema}function _distinct(d,v){var unique={};var arr=[];for(var i in d){if(typeof unique[d[i][v]]=="undefined"){arr.push(d[i][v])}unique[d[i][v]]=""}return arr}function _checkUnique(d,a){for(var key in a){if(key==d){_log(1,name+" already exists in schema");return false}}return true}function _checkForTable(d,a){if(a[d]===undefined){_log(1,d+" does not exist in schema.");return false}else{return true}}function _filterPredicate(data,p,e){var subset=data.filter(function(d){return d[p]==e});return subset}function _colToUppercase(d){for(var i=0;i<d.length;i++){var a=d[i];for(var key in a){var temp;if(a.hasOwnProperty(key)){temp=a[key];delete a[key];a[key.toUpperCase()]=temp}}d[i]=a}return d}function _log(c,t){var log=["INFO","WARNING","ERROR"],logLvl=0;if(c>logLvl)console.log(log[c]+": "+t)}return jSchema});